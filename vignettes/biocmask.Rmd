---
title: "biocmask Usage Guide"
author:
    - name: Justin Landis
      orcid: 0000-0001-5501-4934
    - name: Michael Love
      orcid: 0000-0001-8401-0545
date: "`r format(Sys.time(), '%m/%d/%Y')`"
output: rmarkdown::html_document
bibliography: library.bib
vignette: |
  %\VignetteIndexEntry{biocmask Usage Guide}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Quick start

`biocmask` provides efficient abstractions to the *SummarizedExperiment* such
that using common dplyr functions feels as natural to operating on a
*data.frame* or *tibble*. `biocmask` uses
[data-masking](https://rlang.r-lib.org/reference/topic-data-mask-programming.html)
from the `rlang` package in order to connect dplyr functions to
*SummarizedExperiment* slots in a manner that aims to be intuitive and avoiding
ambiguity in outcomes.

## Supported data types and operations

`biocmask` works on *SummarizedExperiment* objects, as well as most
classes derived from this, including *DESeqDataSet*,
*SingleCellExperiment*, etc.

It supports the following operations:

* `mutate`
* `select`
* ...

## Typical use case

```{r message=FALSE, warning=FALSE}
library(airway)
data(airway)
library(dplyr)
```

```{r echo=FALSE}
# clean up the metadata a bit to make it easier to view
colData(airway) <- colData(airway)[,1:4]
rowData(airway) <- rowData(airway)[,c(1:2,4)]
```

```{r message=FALSE}
library(biocmask)
# add data (mutate) to any of the three tables,
# assay, colData, rowData,
# ...using contextual helpers cols() and rows()
airway |>
  mutate(log_counts = log1p(counts),
         cols(treated = dex == "trt"),
         rows(new_id = paste0("gene-", gene_name)))
```

The operations can span contexts, and only the necessary data will be extracted
from each context for computation:

```{r}
airway$sizeFactor <- runif(8, .9, 1.1)

# making scaled counts, then computing row means:
airway |>
  mutate(scaled_counts = counts / .cols$sizeFactor, #
         rows(ave_scl_cts = rowMeans(.assays_asis$scaled_counts)))
```

Calling `.cols` in the assay context produces an object of the matching size and
orientation to the other assay data.

Alternatively we could have used *purrr* to compute row means:

```{r}
airway |>
  mutate(scaled_counts = counts / .cols$sizeFactor,
         # You may expect a list when accessing other contexts
         # from either the rows() or cols() contexts.
         rows(ave_scl_cts = purrr::map_dbl(.assays$counts, mean)))
```

See below for details on how objects are made available across contexts.

`biocmask` also enables common grouping and summarization routines:


```{r}
summary <- airway |>
  group_by(rows(gene_biotype)) |>
  summarize(col_sums = colSums(counts))
# summarize returns a SummarizedExperiment here,
# retaining rowData and colData

summary |> rowData()

# visualizing the output as a tibble:
library(tibble)
summary |>
  assay("col_sums") |>
  as_tibble() |>
  add_column(type = rowData(summary)$gene_biotype, .before=1)
```

## Related work

We note that `biocmask` is highly related to other *tidyomics* projects including:

* tidySummarizedExperiment
* plyranges
* DFplyr
* and more.

Here we have focused on the design principles of ...

# Manipulating *SummarizedExperiment* with `biocmask`

Put your diagrams here, those are great. They can go in `/images`

## assay context

a little about assay

## rows context

a little about rows

## cols context

I thought we might re-use this example, of the new way and the "old way" of
dividing out a vector along the columns:

```{r}
# here the `.cols$` pronoun reshapes the data to fit the `assays` context
airway |>
  mutate(scaled_counts = counts / .cols$sizeFactor,
         rows(ave_scl_cts = rowMeans(.assays_asis$scaled_counts)))

# this is equivalent to the following, where we have to transpose
# the `counts` assay data twice to enable the correct recycling
# of the size factor vector
airway |>
  mutate(scaled_counts = t(t(counts) / .cols_asis$sizeFactor),
         rows(ave_scl_cts = rowMeans(.assays_asis$scaled_counts)))
```

# Advanced features

What is super cool and you want to show advanced users

# Troubleshooting and best practices

Any tips on how to get started, or how to write things most efficiently?

# Community and support

I can put stuff in here

# Session info

```{r}
devtools::session_info()
```

# References
